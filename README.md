# 骑手排班思路

## 1. 确定每天需要的骑手数量与结构

> 理念：根据一周的场景得到订单，合理分配骑手，这一阶段是分组进行的，不关注骑手个人，至于骑手结构，是在一个区间值内，用线性规划求最优的结构，高kpi：中kpi：低kpi的占比。最大化目标是 **订单/运力** , 就是平均运送一单的骑手数量最大化，同时需要避免某天运力富裕很多，一天很紧张，需要考虑订单量将运力均匀发布到每一天。

### 1.1 天气确定 ###

衡量天气优劣的指标是**UTCI（通用热气候指数）**，该指标是天气领域评估人体热舒适度的核心指标，UTCI的范围是从-50到50，一般-10到30是舒适范围。

#### **1.1.1. 计算公式** ####

$$ UTCI = T_a + \sum_{i,j,k,l,m} C_{ijk\cdots} \cdot T_a^a \cdot V^j \cdot {RH}^k \cdot {MRT}^l $$

其中：
- $T_a$：空气温度（℃）
- $V$：2m高度风速（m/s）
- $RH$：相对湿度（%）
- $MRT$：平均辐射温度（℃）
- $C_{ijk\cdots}$：多项式回归系数


#### **1.2.2 分类** ####

| 分类与图标          | UTCI范围（℃）  | 描述            | 生理影响                                                                 |
|---------------------|---------------|----------------|--------------------------------------------------------------------------|
| 🧊 极端寒冷          | ≤ -40         | 极端低温        | 冻伤风险极高，暴露10分钟即可导致组织损伤                                  |
| ❄️❄️ 非常强烈寒冷      | -40 ~ -27     | 剧烈寒潮        | 肢体麻木加速，未防护皮肤15分钟出现冻伤                                    |
| ❄️ 强烈寒冷        | -27 ~ -13     | 强寒流          | 体感如刀割，30分钟暴露可致轻度冻伤                                        |
| 🧣 中等寒冷          | -13 ~ 0       | 典型冬季        | 颤抖反射激活，末梢循环减弱                                                |
| 🌡️ 轻度寒冷          | 0 ~ 9         | 初冬/深秋       | 代谢率提升，需增加衣物维持核心体温                                        |
| 🌥️ 舒适              | 9 ~ 26        | 理想气候        | 人体热平衡最佳状态，无需额外适应措施                                      |
| 🌤️ 轻度热应激        | 26 ~ 32       | 温热环境        | 开始出汗，心血管系统轻微压力                                              |
| 🌞 中等热应激        | 32 ~ 38       | 持续高温        | 热蓄积加速，可能引发热痉挛                                                |
| 🔥 非常强烈热应激    | 38 ~ 46       | 酷热天气        | 热射病风险显著，建议避免户外活动                                          |
| 🔥🔥 极端热应激        | ≥ 46          | 致命高温        | 核心体温失控，1小时内可能引发多器官衰竭                                   |


#### **1.1.3天气数据来源（只有14天试用期）**：心知天气   ####

`https://seniverse.yuque.com/hyper_data/api_v3/sl6gvt`

```json

    "daily": [{                          //返回指定days天数的结果
      "date": "2015-09-20",              //日期（该城市的本地时间）
      "text_day": "多云",                //白天天气现象文字
      "code_day": "4",                  //白天天气现象代码
      "text_night": "晴",               //晚间天气现象文字
      "code_night": "0",                //晚间天气现象代码
      "high": "26",                     //当天最高温度
      "low": "17",                      //当天最低温度
      "precip": "0",                    //降水概率，范围0~1，单位百分比（目前仅支持国内城市）
      "wind_direction": "",             //风向文字
      "wind_direction_degree": "255",   //风向角度，范围0~360
      "wind_speed": "9.66",             //风速，单位km/h（当unit=c时）、mph（当unit=f时）
      "wind_scale": "",                 //风力等级
      "rainfall": "0.0",                //降水量，单位mm（目前仅支持国内城市）
      "humidity": "76"                  //相对湿度，0~100，单位为百分比
    }
}
```

#### **1.1.4 计算代码** ####

```python
#有点多 省略
```

### 1.2  假日确定 ###

```python
import holidays
def is_holiday(self,date):
    """判断是否节假日"""
    cn_holidays = holidays.China()
    return date in cn_holidays
```
### 1.3 周末确定 ###

```python
def is_weekend(self, date):
    """判断是否周末"""
    return date.weekday() >= 5
```
### 1.4 订单数确定 ###
五大场景：
 不同场景骑手结构 单量越大，高kpi越多  总的骑手结构：高kpi：中kpi：低kpi=0.3:0.4:0.3
- 正常天气+工作日 ：	高kpi：中kpi：低kpi=0.20:0.4:0.40
- 恶劣天气+工作日 ：        高kpi：中kpi：低kpi=0.25:0.4:0.35
- 正常天气+周末 ：          高kpi：中kpi：低kpi=0.30:0.4:0.30
- 恶劣天气+周末 ：          高kpi：中kpi：低kpi=0.35:0.4:0.25
- 节假日：                 高kpi：中kpi：低kpi=0.40:0.4:0.20
```python
scenario_params ={
            'festival&holiday': {'order_factor': 1.30, 'kpi_mix': [0.4, 0.4, 0.2]},
            'normal_weekday': {'order_factor': 1.00, 'kpi_mix': [0.2, 0.4, 0.4]},
            'bad_wea_weekday': {'order_factor': 1.05, 'kpi_mix': [0.25, 0.4, 0.35]},
            'normal_weekend': {'order_factor': 1.15, 'kpi_mix': [0.3, 0.4, 0.3]},
            'bad_wea_weekend': {'order_factor': 1.20, 'kpi_mix': [0.35, 0.4, 0.25]}
        }
```
对美团数据的不同场景单量均值统计
- 正常天气+工作日 ：20000    

- 恶劣天气+工作日：21350 

- 正常天气+周末：22837

- 节假日：26000


**推测出**恶劣天气+周末 约为   240000（1350+2837）
   **比值确定为**：**1：1.05：1.15：1.20：1.3**
![image-20250417222949967](./../实习-2024暑假-无限集数/picMarkdown/image-20250417222949967.png)

### 1.5 确定骑手运力	![mage-20250417225211353](./../实习-2024暑假-无限集数/picMarkdown/image-20250417225211353.png)

**不同类型骑手运力比**：一般：良好：优秀 =  15：25：40 即 3 ：5 ：8

### 1.6  确定骑手排班偏好 ###
实际上，更合适的让骑手自己选择排序，但是现在不行，就根据年龄等，用代码生成了一份。
   **偏好值范围**：

- **1**：不喜欢该时段。
- **2**：可以接受该时段
- **3**：非常喜欢该时段。

**生成依据**：

- 根据骑手的个人特征生成偏好，例如：
- **有孩子**的骑手可能更倾向于选择早班（方便接送孩子）。
- **年长**的骑手可能不喜欢熬夜，因此夜班偏好值较低。
- **单身或年轻**的骑手可能更倾向于夜班（时间灵活）。

### 1.7 确定每天所需的骑手数量与结构
#### **1. 问题描述** ####
第一阶段的目标是根据 7 天的订单预测，确定每天需要的骑手总人数以及优秀、良好、一般骑手的比例构成，使得：
1. 每天的理论配送能力与订单需求接近，且各天的理论配送能力与订单需求比值浮动范围较小。
2. 满足一周内骑手总人数的全局分配比例限制。
3. 满足每日优秀、良好、一般骑手的比例限制。
#### **2. 目标函数** ####
目标是最大化 7 天每天的理论配送能力与订单需求比值的和：
	$$\text{Maximize: } \sum_{d=1}^{7} \frac{x_{\text{excellent},d} \cdot e_{\text{excellent}} + x_{\text{good},d} \cdot e_{\text{good}} + x_{\text{average},d} \cdot e_{\text{average}}}{\text{订单量}_d}$$
其中：

- $x_{\text{excellent},d}, x_{\text{good},d}, x_{\text{average},d}$：第 $d$ 天优秀、良好、一般骑手的数量。
- $e_{\text{excellent}}, e_{\text{good}}, e_{\text{average}}$：优秀、良好、一般骑手的效率系数（分别为 40、25、15）。
- $\text{订单量}_d$：第 $d$ 天的订单量。
#### **3. 约束条件** ####
##### **（1）全局约束** #####
一周内每种类型骑手的总工作天数需满足全局比例限制，一个骑手都只上五天班：
	$$\sum_{d=1}^{7} x_{\text{excellent},d} = 5 \cdot \text{优秀骑手总数}$$
	$$\sum_{d=1}^{7} x_{\text{good},d} = 5 \cdot \text{良好骑手总数}$$
	$$\sum_{d=1}^{7} x_{\text{average},d} = 5 \cdot \text{一般骑手总数}$$

##### **（2）每日骑手总人数约束** #####
每天的优秀、良好、一般骑手总人数必须满足当天骑手	需求：
	$x_{\text{excellent},d} + x_{\text{good},d} + x_{\text{average},d} = \text{骑手需求}_d$

##### **（3）每日骑手比例约束** #####

每天优秀、良好、一般骑手的比例应在合理范围内波动：
	$$0.2 \cdot \text{骑手需求}_d \leq x_{\text{excellent},d} \leq 0.4 \cdot \text{骑手需求}_d$$
	$$0.35 \cdot \text{骑手需求}_d \leq x_{\text{good},d} \leq 0.45 \cdot \text{骑手需求}_d$$
	$$0.2 \cdot \text{骑手需求}_d \leq x_{\text{average},d} \leq 0.4 \cdot \text{骑手需求}_d$$

##### **（4）运力充足率约束** #####
每天的理论配送能力与订单需求比值需接近全局基准比值，这个约束很重要，保障的是每天的运力充足率差不多，都在基准值附近，根据订单数吧运力均匀分布到每一天，：
	$$\text{基准比值} = \frac{\text{一周总配送能力}}{\text{一周总订单量}}$$
	$$\text{基准比值} - 0.01 \leq \frac{x_{\text{excellent},d} \cdot e_{\text{excellent}} + x_{\text{good},d} \cdot e_{\text{good}} + x_{\text{average},d} \cdot e_{\text{average}}}{\text{订单量}_d}$$

#### **4. 理论依据** ####
1. **线性规划优化**
    在约束条件下最大化目标函数，确保每天的配送能力与订单需求比值接近，同时平衡一周内骑手的工作负担。
2. **资源分配原则**
    满足每天订单量的同时，合理调整骑手结构比例，优化整体运力。
## 2.确定每天具体有哪些骑手上班 ##
> 思路： 最优化目标是准时单量，第一阶段的得出结构与比例是基于骑手组的，本阶段进一步细分，分人进行，关注核心kpi，准时单量，最大化目标是准时单量最大化，第一阶段的骑手解构是约束条件
### 2.1 计算每个骑手平均准时率 ###
骑手12月骑手的总准时单/总单 
### 2.2 骑手的运力
以12月的骑手总完成单量/上班天数
###  2.3 每天具体有哪些骑手上班 ###
#### **1. 问题描述** ####
第二阶段的目标是在第一阶段确定的每天骑手总人数及优秀、良好、一般骑手构成的基础上，进一步分配具体哪些骑手上班，以最大化订单准时完成量，满足以下要求：
#### **2. 目标函数** ####
设：
- $x_{r,d,t}$ 表示骑手 $r$ 在第 $d$ 天的 $t$ 时段是否上班（0 或 1）。
- $A_r$ 表示骑手 $r$ 上个月的 **平均日完成订单量**。
- $P_r$ 表示骑手 $r$ 上个月的 **准时配送率**。
- 总准时单量的目标函数为：
$\text{Maximize: } \sum_{r \in \text{Riders}} \sum_{d=1}^{7} \sum_{t \in \text{Time\_Slots}} x_{r,d,t} \cdot A_r \cdot P_r$
其中：
- $A_r \cdot P_r$ 表示骑手 $r$ 的 **准时单量能力**。
- $x_{r,d,t} \cdot A_r \cdot P_r$ 表示骑手 $r$ 在第 $d$ 天的 $t$ 时段所贡献的准时单量。
#### **3. 约束条件** ####
##### **（1）每日骑手总人数约束** #####
每天的骑手总人数及构成需严格符合第一阶段的分配结果：
	$\sum_{r \in \text{Riders}} x_{r,d} = \text{骑手需求}_d$
对于优秀、良好、一般骑手分别满足：
	$$\sum_{r \in \text{Excellent\_Riders}} x_{r,d} = \text{优秀骑手数量}_d$$
	$$\sum_{r \in \text{Good\_Riders}} x_{r,d} = \text{良好骑手数量}_d$$
	$$\sum_{r \in \text{Average\_Riders}} x_{r,d} = \text{一般骑手数量}_d$$

##### **（2）骑手工作天数约束** #####

每个骑手一周的工作天数不超过 5 天：
	$\sum_{d=1}^{7} x_{r,d} \leq 5 \quad \forall r \in \text{Riders}$

##### **（3）骑手当天唯一工作约束** #####
每个骑手在同一天只能上班一次：
	$x_{r,d} \in \{0, 1\} \quad \forall r \in \text{Riders}, \forall d \in \{1, 2, \dots, 7\}$

#### **4. 理论依据** ####
1. **线性规划优化**
    通过约束条件确保每天具体分配的骑手满足总人数及结构要求，同时最大化订单准时完成量。
2. **效率优化原则**
    优先分配效率高的骑手（优秀骑手）以提高整体准时单量，同时平衡良好和一般骑手的分配。
3. **公平性原则**
    每个骑手的工作负担受限于一周最多 5 天，确保分配的公平性。
#### **5. 总结** ####
第二阶段通过线性规划的资源分配优化方法，确定了每天具体上班的骑手名单，使得：
1. 每天的骑手人数及构成严格符合第一阶段的分配结果。
2. 优化了订单准时完成量，提升了整体配送效率，保障客户满意度。
3. 确保了骑手工作负担的公平性和合理性以及可持续性。

## 3.确定每天骑手上班的时间段 ##

#### **1. 问题描述**

**强调**：午饭、晚饭两个高峰，所有人都要上班，本阶段主要是**人文关怀**，尊重骑手意愿

第三阶段的目标是在前面两个阶段的基础上，合理分配骑手到具体的工作时段（早茶、下午茶、夜宵），主要基于骑手个人偏好，理论上应该让骑手自己在三个时间段排序选择的，但是本研究无法进行，故而根据其年龄、家庭等特征，系统为其生成了一个偏好。最大化最大化骑手满意度，同时满足如下要求：

1. 午饭和晚饭两个高峰期是固定工作时段，所有骑手都需覆盖，另外每个骑手每天还需选择一个时段工作。
2. 早茶、下午茶、夜宵三个时段可根据骑手的偏好灵活分配，但每个时段的骑手人数符合比例要求（如早、中、晚的比例约束为 $1:1:1$，允许误差不超过 20%）。
3. 优化分配使骑手的偏好总和得到最大化，同时满足每个时段的基本运力需求。

#### **2. 目标函数** ####

目标是最大化一周内所有骑手的偏好匹配总分：

​	$\text{Maximize: } \sum_{r \in \text{Riders}} \sum_{d=1}^{7} \sum_{t \in \text{Time\_Slots}} x_{r,d,t} \cdot \text{Preference}_{r,t}$

其中：

- $x_{r,d,t}$：二元变量，表示骑手 $r$ 在第 $d$ 天的时段 $t$ 是否工作（1 为工作，0 为不工作）。
- $\text{Preference}_{r,t}$：骑手 $r$ 对时段 $t$ 的偏好分值（1-3 分，3 表示非常喜欢）。
- $\text{Time\_Slots}$：包括早茶、下午茶、夜宵三个灵活时段。

#### **3. 约束条件** ####

##### **（1）午饭和晚饭时段全覆盖** #####

所有骑手必须在午饭和晚饭两个高峰期工作：

​	$\forall r \in \text{Riders}, \forall d \in \{1, 2, \dots, 7\}, \quad x_{r,d,\text{lunch}} = 1, \quad x_{r,d,\text{dinner}} = 1$

##### **（2）骑手每日最多选择一个灵活时段** #####

每个骑手每天只能选择一个灵活时段（早茶、下午茶、夜宵）：

​	$\sum_{t \in \{\text{morning}, \text{afternoon}, \text{night}\}} x_{r,d,t} \leq 1 \quad \forall r \in \text{Riders}, \forall d \in \{1, 2, \dots, 7\}$

##### **（3）每个时段的骑手人数约束** #####

目标是控制每天早茶、下午茶、夜宵三个灵活时段骑手的分配比例，使其接近 $1:1:1$，并确保每个时段的骑手人数相差不超过 20%。第三阶段约束方程解释

**时段人数计算** 

每个时段的骑手人数可以表示为：

​     $$\text{Morning\_Count}_d = \sum_{r \in \text{Riders}} x_{r,d,\text{morning}}$$
​	$$\text{Afternoon\_Count}_d = \sum_{r \in \text{Riders}} x_{r,d,\text{afternoon}}$$
​	$$\text{Night\_Count}_d = \sum_{r \in \text{Riders}} x_{r,d,\text{night}}$$

- $\text{Morning\_Count}_d$：第 $d$ 天早茶时段的骑手人数。
- $\text{Afternoon\_Count}_d$：第 $d$ 天下午茶时段的骑手人数。
- $\text{Night\_Count}_d$：第 $d$ 天夜宵时段的骑手人数。

**早茶与下午茶时段人数比例约束**

要求早茶时段人数与下午茶时段人数相差不超过 20%，即满足：

​	$0.8 \cdot \text{Afternoon\_Count}_d \leq \text{Morning\_Count}_d \leq 1.2 \cdot \text{Afternoon\_Count}_d$

**（2）早茶与夜宵时段人数比例约束**

要求早茶时段人数与夜宵时段人数相差不超过 20%，即满足：

​	$0.8 \cdot \text{Night\_Count}_d \leq \text{Morning\_Count}_d \leq 1.2 \cdot \text{Night\_Count}_d$

**（3）下午茶与夜宵时段人数比例约束** 

要求下午茶时段人数与夜宵时段人数相差不超过 20%，即满足：

​	$0.8 \cdot \text{Night\_Count}_d \leq \text{Afternoon\_Count}_d \leq 1.2 \cdot \text{Night\_Count}_d$

#### **4. 理论依据** 

1. **比例约束的意义**
    通过控制三个灵活时段的骑手人数比例，确保每个时段的运力需求得到均衡分配，避免某些时段骑手过多或过少的情况。
2. **20% 的浮动范围**
    允许一定的灵活性，使得骑手分配更具实际操作性，同时不偏离目标比例 $1:1:1$。

#### **5. 总结** ####

第三阶段通过优化灵活时段的骑手分配：

1. 固定覆盖了午饭和晚饭高峰期的工作需求。
2. 根据骑手偏好最大化了整体满意度。
3. 在满足最低运力需求的前提下，实现了骑手意愿与运力需求的有效平衡。

## **4. 结果展示** ##

### **每日骑手及订单数据**

| 日期       | 场景           | 订单量 | 骑手总数 | 优秀骑手 | 良好骑手 | 一般骑手 | 优秀骑手占比 | 良好骑手占比 | 一般骑手占比 | 订单满足率 |
| ---------- | -------------- | ------ | -------- | -------- | -------- | -------- | ------------ | ------------ | ------------ | ---------- |
| 2025-04-21 | 恶劣天气工作日 | 21000  | 922      | 200      | 366      | 356      | 21.69%       | 39.70%       | 38.61%       | 107.10%    |
| 2025-04-22 | 正常天气工作日 | 20000  | 890      | 197      | 341      | 352      | 22.13%       | 38.31%       | 39.55%       | 108.42%    |
| 2025-04-23 | 正常天气工作日 | 20000  | 749      | 285      | 313      | 151      | 38.05%       | 41.79%       | 20.16%       | 107.45%    |
| 2025-04-24 | 正常天气工作日 | 20000  | 781      | 263      | 328      | 190      | 33.67%       | 42.00%       | 24.33%       | 107.85%    |
| 2025-04-25 | 正常天气工作日 | 20000  | 918      | 202      | 356      | 360      | 22.00%       | 38.78%       | 39.22%       | 111.90%    |
| 2025-04-26 | 正常天气周末   | 23000  | 876      | 326      | 334      | 216      | 37.21%       | 38.13%       | 24.66%       | 107.09%    |
| 2025-04-27 | 正常天气周末   | 23000  | 859      | 327      | 357      | 175      | 38.07%       | 41.56%       | 20.37%       | 107.09%    |


### **总统计数据**

- 总骑手数：**5995**  
  - 高 KPI 骑手：**计划 1800，实际 1800**  
  - 中 KPI 骑手：**计划 2395，实际 2395**  
  - 低 KPI 骑手：**计划 1800，实际 1800**

- 骑手上班天数统计：  
  - 上班天数为 5 天的骑手人数：**1199**

### **每日排班结果**

| 日期       | 骑手数量 | 早茶人数 | 下午茶人数 | 夜宵人数 | 午饭人数 | 晚饭人数 |
| ---------- | -------- | -------- | ---------- | -------- | -------- | -------- |
| 2025-04-21 | 922      | 320      | 268        | 334      | 922      | 922      |
| 2025-04-22 | 890      | 309      | 259        | 322      | 890      | 890      |
| 2025-04-23 | 749      | 261      | 218        | 270      | 749      | 749      |
| 2025-04-24 | 781      | 271      | 227        | 283      | 781      | 781      |
| 2025-04-25 | 918      | 319      | 267        | 332      | 918      | 918      |
| 2025-04-26 | 876      | 304      | 255        | 317      | 876      | 876      |
| 2025-04-27 | 859      | 298      | 250        | 311      | 859      | 859      |


### **骑手示例** ###

```json
  {
    kpi_order: 0,
    rider_id: 282074925,
    gender: "男",
    age: 43,
    born_province: "黑龙江省",
    regist_date: "2023-08-14",
    education_description: "初中及以下",
    marriage_status_description: "已婚",
    children_num_description: "1个",
    experience: 16,
    preference: {
        morning: 3,
        afternoon: 2,
        night: 1,
    },
    绩效类别: "优秀骑手",
    cnt_waybill_mean: 78.19354838709677,
    rate_ontime: 0.9834983498349835,
    work_day: [
        "2025-04-21",
        "2025-04-22",
        "2025-04-25",
        "2025-04-26",
        "2025-04-27",
    ],
    work_time: {
        "2025-04-21": [
            "afternoon",
            "peak_dinner",
            "peak_lunch",
        ],
        "2025-04-22": [
            "afternoon",
            "peak_dinner",
            "peak_lunch",
        ],
        "2025-04-25": [
            "afternoon",
            "peak_dinner",
            "peak_lunch",
        ],
        "2025-04-26": [
            "morning",
            "peak_dinner",
            "peak_lunch",
        ],
        "2025-04-27": [
            "afternoon",
            "peak_dinner",
            "peak_lunch",
        ],
    },
```

### **日期示例** ###

```json
 day: 1,
        date_str: "2025-04-21",
        scenario: "bad_wea_weekday",
        weather_data: {
            date: "2025-04-21",
            text_day: "小雨",
            code_day: "13",
            text_night: "多云",
            code_night: "4",
            high: "20",
            low: "12",
            rainfall: "4.19",
            precip: "1.00",
            wind_direction: "北",
            wind_direction_degree: "0",
            wind_speed: "8.4",
            wind_scale: "2",
            humidity: "92",
            score: 34.4,
            classification: "恶劣",
            reason: "湿度不适宜",
        },
        orders: 21000,
        riders_sum: 922,
        high_kpi: 200,
        medium_kpi: 366,
        low_kpi: 356,
        efficiency: 1.0709523809523809,
        riders: [
            
            ]
}
```

